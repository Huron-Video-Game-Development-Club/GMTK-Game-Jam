<!DOCTYPE html>
<html>
<head>
   <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
</head>
<body>

    <script>
    var width = 800;

    var height = 800;
        
    var config = {
        type: Phaser.AUTO,
        width: width,
        height: height,
        pixelArt: true,
        physics: {
            /*default: 'arcade',
            arcade: {
                gravity: { y: 0 }
            }*/
            default: 'matter',
            matter:{
                gravity:{
                    x: 0,
                    y: 0
                },
                debug:{
                    showBody: true,
                    showStaticBody: true
                }
            }
            
        },
        scale: {
    parent: 'game-container',
    mode: Phaser.Scale.HEIGHT_CONTROLS_WIDTH,
    autoRound: true,
    autoCenter: Phaser.DOM.CENTER_BOTH,
  },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    //game constants
    //Experiment with these!
    const FRICTION = 0.005; //0-1 where 0 is no friction
    const BOUNCE = 0.9; //0-1 where 1 means 100% of kinetic energy is retained on bounce by dice
    const FORCE = 10; //Initial force of dice kick
    const SPEED = 3; //Player speed

    //global variables for game objects
    var player;
    var keys;
    var idleAnim;
    var runAnim;
    var platforms;
    var dice;
    var daves = [];


    var isAlive = true;

    //helper method to load a spritesheet from Data URI
    function loadSheet(game, name, dataURI, width, height){
        console.log("NEW");
        var img = new Image();
        img.onload = function(){
            game.textures.addSpriteSheet(name, img, {frameWidth: width, frameHeight: height});
        }
        img.src = dataURI;
    }

    //gets the normalized vector from p1 to p2 times given magnitude
    function getForceVector(p1, p2, magnitude){
        let d = Math.sqrt((p2.x - p1.x) * (p2.x - p1.x) + (p2.y - p1.y) * (p2.y - p1.y));
        return {x: ((p2.x - p1.x)/d) * magnitude, y: ((p2.y - p1.y)/d) * magnitude};
    }

    //returns true or false as to whether a given matter sprite was involved in the collision data
    function wasInvolved(sprite, data){
        return (data.bodyA.name == sprite.body.name || data.bodyB.name == sprite.body.name);
    }
        

    //creates a new dave enemy and appends it to daves
    function createDave(game, x, y){
        dave = game.matter.add.sprite(250, 250, "dave_idle");
        dave.setScale(2);
        dave.setSensor(true);
        dave.play("dave_idle");
        dave.body.name = "dave";
        dave.moveRight = true;
        dave.index = daves.length;
        dave.update = function(){

            if (dave.body.position.x > 600 && dave.moveRight){
                dave.moveRight = false;
            }
            else if (dave.body.position.x < 100 && !dave.moveRight){
                dave.moveRight = true;
            }
            
            if (dave.moveRight){
                dave.setVelocityX(2);
            }
            else{
                dave.setVelocityX(-2);
            }
        }
        daves.push(dave);
        dave.setOnCollideActive((data)=>{
            console.log("collision");
            if (wasInvolved(player, data)){
                player.destroy();
                isAlive = false;
            }
            else if (wasInvolved(dice, data)){
                daves[dave.index] = 0;
                dave.destroy();
            }
        });
        return dave;
    }

    function preload(){
        
        let uri1 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAYCAYAAAC8/X7cAAAAAXNSR0IArs4c6QAAARxJREFUWEftl8sNAjEMRHePNMKZUiiAPqiBPiiAUjjTCEdQkCKZ7Nozjs1nBVxxZvIyJDbjsPDPuPD9D18JcNrsbuVgt+cj3B8smEvIY+BNuGrXdQjCDeA18AC02gyEC6DH4GcAtMNBKdAJ9BowCSBtC4ICiBggAFZbe5UgQNTAAvBoaymYABkGGoDU3l8vj7LDao0Cm/QGFSDLwOoj9bsWAAHJ3jAL0J58xKAFYFINAWQb9ADA35EYMyYJMAAeA1mbpS1fpCeAVxj8AZS460V+awJlL9GU2+k0/Q6g8bceqBzJ56CqDhrdYR8oQhED1MgQcAoAMw6gjWjPKVrXBSBP3DJg66xeENWHd0Az6P1nxq5j6+A0yjStT9bcAc3f6Bk+Ifp6AAAAAElFTkSuQmCC";
        loadSheet(this, 'idle', uri1, 24, 24);

        let uri2 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAYCAYAAAAF6fiUAAAAAXNSR0IArs4c6QAAAb5JREFUaEPtmMFVxDAMRNkjjeyZUiiAPqhh+6AASuFMIxzhhff8njGRZsaSdhMIR+wdjefLiZ3T3fF30wRON61uFH99ePpchh7fXjbpD2Wm+J9aoFIAmR3Hm3b7fwWELfmXAVQGNGpXQNiafwlAdUD/UX8zAKzwM3dBJeBZ/zSA2QLMOwBpZ0BANSLvGqTt+acARAogAKx25FTE1piBwGpb/iGAaAEPgKI9uwuUGioARdvy7wLIKGAB6LWfP96/p13uz2jDSHeDPfg3AVQGNAYzAkBAmE7di/9VAJUBMV0ZBbAn/78AVAfE6MPnkPOZgtGPAGb0Ff9TAJQC/dws896JKKvG2mMuS7v3/wNARYFrAtij/wOAsZ3/5A5Y1hrtUu8EFNXuWVh1ojVG3fR3gHpEXOavLarpeGNrzZsdELrHeP57L1Yu8B7ABsQE3xbTjLG/GUNlftfXYAAzmt77zHtkedrUTRhtR8U80xVM1zEnMQQajSufUcYM2HVeFcBMJ48hLBoscBQwGp+FrKwTPoKsMzdLmFlExRzkD40rnpSmGHWpTxHe9vIuRcoiMueiDkTjmV6QFvwcjQSO8VgCX5sy1ChabDngAAAAAElFTkSuQmCC";
        loadSheet(this, 'run', uri2, 24, 24);
        
        this.load.spritesheet('idle', 'https://google.com/idledsfndsl', {frameWidth: 24, frameHeight: 24}); 

        //this.load.image("rock", "/rock.png");
        let uri3 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAHFJREFUSEtjrKvr/89AQ8AIsqCpqZCRFnaAzKafBehBRQ1fofhg0FlAjIMo8gHJFpCaiga3BYQyH7EpDGc+GLUAlmCoFkTIQYocP6MWEMybVC2useVs+luAKzVgCwt0tUT5YFBbgMuX9KmTCaY3ChQAAE8nCRgzzg/uAAAAAElFTkSuQmCC";
        this.textures.addBase64("rock", uri3);

        this.load.image("dice", "/blue.png");

        this.load.spritesheet("dave_idle", "/dave.png", {frameWidth: 24, frameHeight: 24});
        
    }


    function create(){
        keys = this.input.keyboard.createCursorKeys();
        idleAnim = this.anims.create({
            key: 'idle',
            frames: this.anims.generateFrameNumbers('idle', {start: 0, end: 3}),
            frameRate: 4,
            repeat: -1
        });

        runAnim = this.anims.create({
            key: 'run',
            frames: this.anims.generateFrameNumbers('run', {start: 0, end: 3}),
            frameRate: 8,
            repeat: -1
        });

        daveIdle = this.anims.create({
            key: 'dave_idle',
            frames: this.anims.generateFrameNumbers('dave_idle', {start: 0, end: 3}),
            frameRate: 8,
            repeat: -1
        });

        createDave(this, 200, 200);


        player = this.matter.add.sprite(100, 100, 'run');
        player.setScale(2);
        player.isMoving = {x: false, y: false};
        player.setFixedRotation();
        player.setMass(1);
        player.body.name = "player";

        dice = this.matter.add.sprite(400, 400, "dice");
        dice.setRotation(Math.PI/4);
        dice.setMass(100000);
        dice.setFriction(0);
        dice.setFrictionAir(FRICTION);
        dice.setBounce(BOUNCE);
        dice.tintFill = true;
        dice.clearTint();
        dice.body.name = "dice";

        //create edges of playing area
        var rightEdge = this.matter.add.rectangle(800, 0, 100, 1600, {isStatic: true});
        var leftEdge = this.matter.add.rectangle(0, 0, 100, 1600, {isStatic: true});
        var upEdge = this.matter.add.rectangle(0, 0, 2000, 100, {isStatic: true});
        var downEdge = this.matter.add.rectangle(0, 800, 2000, 100, {isStatic: true});


        //collision events
        dice.setOnCollideActive((data)=>{
            if (keys.space.isDown && interactable && wasInvolved(player, data)){
                var newVelocity = getForceVector(player.body.position, dice.body.position, FORCE);
                console.log(newVelocity);
                dice.setVelocity(newVelocity.x, newVelocity.y);
                console.log("DID IT");
                dice.setAngularVelocity(0.2);
                dice.setTintFill(0xECA72C);
                interactable = false;
            }
        });

    }

    function update(){

        //player movement stuff
        if (isAlive){
            if (keys.left.isDown){
                player.setVelocityX(-SPEED);
                player.setFlipX(false);
                player.isMoving.x = true;
            }
            else if (keys.right.isDown){
                player.setVelocityX(SPEED);
                player.setFlipX(true);
                player.isMoving.x = true;
            }
            else{
                player.isMoving.x = false;
                player.setVelocityX(0);
            }

            if (keys.up.isDown){
                player.setVelocityY(-SPEED);
                player.isMoving.y = true;
            }
            else if (keys.down.isDown){
                player.setVelocityY(SPEED);
                player.isMoving.y = true;
            }
            else{
                player.isMoving.y = false;
                player.setVelocityY(0);
            }

            if (!player.isMoving.x && !player.isMoving.y){
                player.play('idle', true);
                player.setVelocityX(0);
                player.setVelocityY(0);
            }
            else{
                player.play("run", true);
            }
        // player.play("run");
        }
        
        let speed = Math.sqrt(Math.pow(dice.body.velocity.x, 2) + Math.pow(dice.body.velocity.y, 2))
            
        //max speed of 10
        if (speed > 10){
            dice.setVelocityX((dice.body.velocity.x/speed) * 10);
            dice.setVelocityY((dice.body.velocity.y/speed) * 10);
        }
        
        //make dice usable when slow enough
        if (speed < 1.5){
            dice.clearTint();
            interactable = true;
        } 

        for (dave of daves){
            if (dave != 0){
                dave.update();
            }
        }

    }
    </script>

</body>
</html>